{"head":{"title":"Knex","layout":"2017/sheet","updated":"2020-06-03T00:00:00.000Z","category":"Databases","intro":"[Knex](http://knexjs.org/) is an SQL query builder for Node.js.\nThis guide targets v0.13.0.\n"},"body":[{"title":null,"elms":"{: .-three-column}\n","h2":"Getting started"},{"title":"Connect","elms":"\n```js\nrequire('cs/knex')({\n  client: 'pg',\n  connection: 'postgres://user:pass@localhost:5432/dbname'\n})\n```\n\nSee: [Connect](#connect-1)\n","h2":"Getting started"},{"title":"Create table","elms":"\n```js\nknex.schema.createTable('user', (table) => {\n  table.increments('id')\n  table.string('name')\n  table.integer('age')\n})\n.then(() => ···)\n```\n\nSee: [Schema](#schema)\n","h2":"Getting started"},{"title":"Select","elms":"\n```js\nknex('users')\n  .where({ email: 'hi@example.com' })\n  .then(rows => ···)\n```\n{: data-line=\"2\"}\n\nSee: [Select](#select-1)\n","h2":"Getting started"},{"title":"Insert","elms":"\n```js\nknex('users')\n  .insert({ email: 'hi@example.com' })\n```\n{: data-line=\"2\"}\n\nSee: [Insert](#insert-1)\n","h2":"Getting started"},{"title":"Update","elms":"\n```js\nknex('users')\n  .where({ id: 135 })\n  .update({ email: 'hi@example.com' })\n```\n{: data-line=\"2,3\"}\n\nSee: [Update](#update-1)\n","h2":"Getting started"},{"title":"Migrations","elms":"\n```bash\nknex init\nknex migrate:make migration_name\nknex migrate:make migration_name -x ts # Generates a TypeScript migration file\nknex migrate:latest\nknex migrate:rollback\n```\n\nSee: [Migrations](#migrations-1)\n","h2":"Getting started"},{"title":"Seeds","elms":"\n```bash\nknex seed:make seed_name\nknex seed:make seed_name -x ts # Generates a TypeScript seed file\nknex seed:run # Runs all seed files\nknex seed:run --specific=seed-filename.js # Runs a specific seed file\n```\n\nSee: [Seeds](http://knexjs.org/#Seeds)\n","h2":"Getting started"},{"title":null,"elms":"{: .-three-column}\n","h2":"Connect"},{"title":"Libraries","elms":"\n| `pg` | PostgreSQL |\n| `mysql` | MySQL or MariaDB |\n| `sqlite3` | Sqlite3 |\n| `mssql` | MSSQL |\n\nInstall any of these packages along with `knex`.\n\nSee: [Node.js installation](http://knexjs.org/#Installation-node)\n","h2":"Connect"},{"title":"Connect via host","elms":"\n```js\nvar knex = require('knex')({\n  client: 'mysql',\n  connection: {\n    host: '127.0.0.1',\n    user: 'your_database_user',\n    password: 'your_database_password',\n    database: 'myapp_test'\n  },\n  pool: { min: 0, max: 7 }\n})\n```\n{: data-line=\"2,3\"}\n\nSee: [Initializing the library](http://knexjs.org/#Installation-client)\n","h2":"Connect"},{"title":"Connect via URL","elms":"\n```js\nvar pg = require('knex')({\n  client: 'pg',\n  connection: process.env.DATABASE_URL,\n  searchPath: 'knex,public',\n  pool: { min: 0, max: 7 }\n})\n```\n{: data-line=\"2,3\"}\n","h2":"Connect"},{"title":"Connect via Sqlite","elms":"\n```js\nvar knex = require('knex')({\n  client: 'sqlite3',\n  connection: { filename: './mydb.sqlite' }\n})\n```\n{: data-line=\"2,3\"}\n","h2":"Connect"},{"title":"Where","elms":"\n```js\nknex\n  .from('books')\n  .select('title', 'author', 'year')\n```\n\n#### Where\n\n```js\n  .where('title', 'Hello')\n  .where({ title: 'Hello' })\n  .whereIn('id', [1, 2, 3])\n  .whereNot(···)\n  .whereNotIn('id', [1, 2, 3])\n```\n\n#### Where conditions\n\n```js\n  .whereNull('updated_at')\n  .whereNotNull(···)\n```\n\n```js\n  .whereExists('updated_at')\n  .whereNotExists(···)\n```\n\n```js\n  .whereBetween('votes', [1, 100])\n  .whereNotBetween(···)\n```\n\n```js\n  .whereRaw('id = ?', [1])\n```\n\n#### Where grouping\n\n```js\n  .where(function () {\n    this\n      .where('id', 1)\n      .orWhere('id', '>', 10)\n  })\n```\n\nSee: [Where clauses](http://knexjs.org/#Builder-wheres)\n","h2":"Select"},{"title":"Join","elms":"\n```js\nknex('users')\n```\n\n#### Basic join\n\n```js\n  .join('contacts', 'users.id', '=', 'contacts.id')\n  .join('contacts', {'users.id': 'contacts.id'})\n```\n\n#### Strings\n\n```js\n  .join('accounts', 'accounts.type', '=', knex.raw('?', ['admin']))\n```\n\n#### Directions\n\n```js\n  .leftJoin(···)\n  .leftOuterJoin(···)\n  .rightJoin(···)\n  .rightOuterJoin(···)\n  .outerJoin(···)\n  .fullOuterJoin(···)\n  .crossJoin(···)\n```\n\n#### Raw\n\n```js\n  .joinRaw('natural full join table1')\n```\n\n#### Grouping\n\n```js\n  .join('accounts', function () {\n    this\n      .on('accounts.id', '=', 'users.account_id')\n      .orOn('accounts.owner_id', '=', 'users.id')\n\n      .onIn('accounts.id', [1, 2, 3, 5, 8])\n      .onNotIn(···)\n\n      .onNull('accounts.email')\n      .onNotNull(···)\n\n      .onExists(function () {\n        this.select(···)\n      })\n      .onNotExists(···)\n  })\n```\n\nSee: [Join methods](http://knexjs.org/#Builder-join)\n","h2":"Select"},{"title":"Others","elms":"\n```js\nknex('users')\n  .distinct()\n```\n\n#### Group\n\n```js\n  .groupBy('count')\n  .groupByRaw('year WITH ROLLUP')\n```\n\n#### Order\n```js\n  .orderBy('name', 'desc')\n  .orderByRaw('name DESC')\n```\n\n#### Offset/limit\n\n```js\n  .offset(10)\n  .limit(20)\n```\n\n#### Having\n\n```js\n  .having('count', '>', 100)\n  .havingIn('count', [1, 100])\n```\n\n#### Union\n\n```js\n  .union(function() {\n    this.select(···)\n  })\n  .unionAll(···)\n```\n\nSee: [Query builder](http://knexjs.org/#Builder)\n","h2":"Select"},{"title":"Etc","elms":"\n```js\nknex('users')\n  .pluck('id')\n  .then(ids => { ··· })\n```\n```js\nknex('users')\n  .first()\n  .then(user => { ··· })\n```\n\n#### Booleans\n\n```js\n  .count('active')\n  .count('active as is_active')\n```\n\n#### Numbers\n\n```js\n  .min('age')\n  .max('age')\n  .sum('age')\n  .sumDistinct('age')\n  .avg('age')\n```\n\nSee: [Query builder](http://knexjs.org/#Builder)\n","h2":"Select"},{"title":"Create table","elms":"\n```js\nknex.schema.createTable('accounts', table => {\n```\n\n#### Columns\n\n```js\n  table.increments('id')\n  table.string('account_name')\n  table.integer('age')\n  table.float('age')\n  table.decimal('balance', 8, 2)\n  table.boolean('is_admin')\n  table.date('birthday')\n  table.time('created_at')\n  table.timestamp('created_at').defaultTo(knex.fn.now())\n  table.json('profile')\n  table.jsonb('profile')\n  table.uuid('id').primary()\n```\n\n#### Constraints\n\n```js\n  table.unique('email')\n  table.unique(['email', 'company_id'])\n  table.dropUnique(···)\n```\n\n#### Indices\n\n```js\n  table.foreign('company_id')\n    .references('companies.id')\n  table.dropForeign(···)\n```\n\n#### Variations\n\n```js\n  table.integer('user_id')\n    .unsigned()\n    .references('users.id')\n```\n\n```js\n})\n.then(() => ···)\n```\n{: .-setup}\n\nSee: [Schema builder](http://knexjs.org/#Schema)\n","h2":"Schema"},{"title":"Alter table","elms":"\n```js\nknex.schema.table('accounts', table => {\n```\n\n#### Create\n\n```js\n  table.string('first_name')\n```\n\n#### Alter\n\n```js\n  table.string('first_name').alter()\n  table.renameColumn('admin', 'is_admin')\n```\n\n#### Drop\n\n```js\n  table.dropColumn('admin')\n  table.dropTimestamps('created_at')\n```\n\n```js\n})\n```\n{: .-setup}\n\nSee: [Schema builder](http://knexjs.org/#Schema)\n","h2":"Schema"},{"title":"Other methods","elms":"\n```js\nknex.schema\n  .renameTable('persons', 'people')\n  .dropTable('persons')\n```\n\n```js\n  .hasTable('users').then(exists => ···)\n  .hasColumn('users', 'id').then(exists => ···)\n```\n\nSee: [Schema builder](http://knexjs.org/#Schema)\n","h2":"Schema"},{"title":null,"elms":"{: .-three-column}\n","h2":"Modifying"},{"title":"Insert","elms":"\n```js\nknex('users')\n```\n\n#### Insert one\n\n```js\n  .insert({ name: 'John' })\n```\n\n#### Insert many\n\n```js\n  .insert([\n    { name: 'Starsky' },\n    { name: 'Hutch' }\n  ])\n```\n\nSee: [Insert](http://knexjs.org/#Builder-insert)\n","h2":"Modifying"},{"title":"Update","elms":"\n```js\nknex('users')\n  .where({ id: 2 })\n  .update({ name: 'Homer' })\n```\n\nSee: [Update](http://knexjs.org/#Builder-update)\n","h2":"Modifying"},{"title":"Delete","elms":"\n```js\nknex('users')\n  .where({ id: 2 })\n  .del()\n```\n\nSee: [Delete](http://knexjs.org/#Builder-del)\n","h2":"Modifying"},{"title":"Setting up","elms":"\n#### Create knexfile.js\n\n```\n./node_modules/.bin/knex init\n```\n\n#### Create a migration\n\n```\nknex migrate:make migration_name\nknex migrate:make migration_name --env production\n```\n\n#### Run migrations\n\n```\nknex migrate:latest\nknex migrate:latest --env production\n```\n\n#### Rollback\n\n```\nknex migrate:rollback\nknex migrate:rollback --env production\n```\n\nSee: [Migrations](http://knexjs.org/#Migrations)","h2":"Migrations"}]}